{% extends "base.html" %}
{% block title %}{{ endpoint.name }} - Settings{% endblock %}
{% block body %}
<div class="app-shell">
    {% include "sidebar.html" %}
    <main class="app-content">
        <ul class="breadcrumb">
            <li><a href="/dashboard">Dashboard</a></li>
            <li><a href="/endpoints/{{ endpoint_id }}">{{ endpoint.name }}</a></li>
            <li><span class="current">Settings</span></li>
        </ul>

        <div class="page-header">
            <h2>Endpoint Settings</h2>
        </div>

        <div class="narrow-content">
            <form id="settings-form">
                <div class="space-y-4 mb-8">
                    <div>
                        <label class="form-label" for="ep-name">Name</label>
                        <input class="form-input" type="text" id="ep-name" value="{{ endpoint.name }}" required>
                    </div>
                </div>

                <h3 class="text-lg font-bold tracking-tight text-neutral-900 mb-4">Configuration</h3>

                <div class="card card-body space-y-5">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="form-label" for="rate-limit">Rate Limit</label>
                            <input class="form-input" type="number" id="rate-limit" value="{{ rate_limit }}" min="0">
                            <span class="form-hint">Max submissions per window</span>
                        </div>
                        <div>
                            <label class="form-label" for="rate-window">Rate Window (seconds)</label>
                            <input class="form-input" type="number" id="rate-window" value="{{ rate_limit_window }}" min="1">
                            <span class="form-hint">Window duration in seconds</span>
                        </div>
                    </div>

                    <div>
                        <label class="form-label" for="cors-origins">CORS Origins</label>
                        <input class="form-input" type="text" id="cors-origins" value="{{ cors_origins }}" placeholder="https://example.com">
                        <span class="form-hint">Comma-separated origins, leave empty for *</span>
                    </div>

                    <div>
                        <label class="form-label" for="honeypot-field">Honeypot Field</label>
                        <input class="form-input" type="text" id="honeypot-field" value="{{ honeypot_field }}" placeholder="_hp">
                        <span class="form-hint">Hidden field name - submissions with this filled are silently rejected</span>
                    </div>

                    <div>
                        <label class="flex items-center gap-3 cursor-pointer">
                            <input class="form-checkbox" type="checkbox" id="store-metadata"{% if store_metadata %} checked{% endif %}>
                            <div>
                                <span class="text-sm font-semibold text-neutral-700">Store Metadata</span>
                                <span class="form-hint mt-0">Record IP, user-agent, referer</span>
                            </div>
                        </label>
                    </div>

                    <div>
                        <label class="form-label" for="redirect-url">Redirect URL</label>
                        <input class="form-input" type="url" id="redirect-url" value="{{ redirect_url }}" placeholder="https://example.com/thanks">
                        <span class="form-hint">Redirect here after form submission</span>
                    </div>

                    <div>
                        <label class="form-label" for="retention-days">Retention Days</label>
                        <input class="form-input w-32" type="number" id="retention-days" value="{{ retention_days }}" min="1" placeholder="30">
                        <span class="form-hint">Auto-delete after N days, leave empty for forever</span>
                    </div>
                </div>

                <div class="mt-8">
                    <button class="btn btn-primary" type="button" onclick="saveSettings()">
                        <i data-lucide="check" style="width:16px;height:16px;"></i> Save Settings
                    </button>
                </div>
            </form>
        </div>
    </main>
</div>
<script>
async function saveSettings() {
    const token = document.cookie.split(';').find(c => c.trim().startsWith('access_token='))?.split('=')[1];

    const corsRaw = document.getElementById('cors-origins').value.trim();
    const corsOrigins = corsRaw ? corsRaw.split(',').map(s => s.trim()).filter(Boolean) : [];
    const retDays = document.getElementById('retention-days').value.trim();

    const settings = {
        rate_limit: parseInt(document.getElementById('rate-limit').value) || 10,
        rate_limit_window_secs: parseInt(document.getElementById('rate-window').value) || 60,
        cors_origins: corsOrigins,
        honeypot_field: document.getElementById('honeypot-field').value.trim(),
        store_metadata: document.getElementById('store-metadata').checked,
        redirect_url: document.getElementById('redirect-url').value.trim(),
        retention_days: retDays ? parseInt(retDays) : null
    };

    const res = await fetch(`/api/v1/endpoints/{{ endpoint_id }}`, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${token}`},
        body: JSON.stringify({
            name: document.getElementById('ep-name').value,
            settings
        })
    });
    if (res.ok) { alert('Saved!'); location.reload(); }
    else { const d = await res.json(); alert(d.error); }
}
</script>
{% endblock %}
